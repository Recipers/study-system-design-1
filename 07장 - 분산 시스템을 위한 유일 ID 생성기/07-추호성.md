# 7. 분산 시스템을 위한 유일ID 생성기 설계

분산 시스템에서 사용될 유일 ID 생성기 설계가 목적이다. 기존 auto increment 속성은 분산 환경에서 작동하기 어렵기 때문에, 새로운 접근법이 필요하다.

## 1. 문제 이해 및 설계 범위 확정

면접관과 충분한 대화를 통해 문제를 정의하고 모호함을 해소하자. 

- ID는 유일해야 한다.
  
- ID는 숫자로만 구성되어야 한다.
- ID는 64비트로 표현할 수 있어야 한다.
- ID는 발급 날짜에 따라 정렬 가능해야 한다.
- 초당 1만개의 ID를 만들 수 있어야 한다.

## 2. 개략적 설계안 제시 및 동의 구하기

분산 시스템에서 유일 ID 보장 방법은 다음과 같다.

- 다중 마스터 복제
  
- UUID
- 티켓 서버
- 트위터 스노플레이크 접근법

### 다중 마스터 복제

다중 마스터 복제 접근법은 데이터베이스의 auto increment 기능을 활용하되, 1이 아닌 서버의 수만큼 증가하는 방식이다. 이는 규모 확장성 문제를 어느정도 해결할 수 있는데, 다음과 같은 단점이 있다.

![image](https://github.com/user-attachments/assets/9d8e8b06-edb7-42ce-b73e-ba0728667b83)

- 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다.
  
- ID의 유일성은 보장되겠지만 그 값이 시간 흐름에 맞춰 커지도록 보장할 순 없다.
- 서버 수의 변경에 취약하다.

### UUID

UUID는 유일성이 보장되는 ID를 만드는 간단한 방법이다. UUID는 컴퓨터 시스템에 저장되는 정보블 식별하기 위한 128비트의 수다. UUID는 만드는 방법이 단순하며, 동기화 문제를 해결하기 때문에 규모 확장이 쉽다는 장점이 있지만, 비트 수가 크며 시간순으로 정렬할 수 없다는 단점이 있다.

![image](https://github.com/user-attachments/assets/c9bcaf9e-9b58-46d2-a8ff-d11f30ede965)

### 티켓 서버

티켓 서버는 ID를 만드는 중앙 집중형 서버를 만들어 공유하는 방식이다. 유일성이 보장되며 구현이 쉽다는 장점이 있지만, SPOF 문제가 발생할 수 있다는 단점이 있다.

![image](https://github.com/user-attachments/assets/45467a19-3d94-4551-9b5f-d55551125433)

### 트위터 스노플레이크 접근법

64비트의 데이터를 사인, 타임스탬프, 데이터센터, 서버, 일련번호로 기능을 구분하여 저장하는 방식이다. 각 위치의 자세한 역할은 다음과 같다.

![image](https://github.com/user-attachments/assets/13d61173-3a19-4853-8144-ec692e50be55)

- 사인 비트 : 1비트를 할당한다. 지금은 쓸모가 없다.
  
- 타임 스탬프 : 41비트를 할당한다. 기원 시각 이후로 몇 밀리초가 증가했는지 저장한다.
- 데이터센터 : 5비트를 할당한다. 데이터센터의 고유 번호를 할당한다. 총 32개의 센터를 지원할 수 있다.
- 서버 : 5비트를 할당한다. 데이터센터 내의 서버 고유 번호를 할당한다. 총 32개의 센터를 지원할 수 있다.
- 일련번호 : 12비트를 할당한다. ID를 생성할 때, AUTO INCREMENT 방식을 적용한다. 이는 밀리초마다 0으로 초기화 된다. 일련번호는 각 서버마다 개별적으로 적용된다.(다른 서버에서 ID를 만들어도 일련번호의 크기에 영향을 주지 않는다)

## 3. 상세 설계

트위터 스노플레이크 접근법으로 요구사항을 만족하는 ID를 만들어보자 !

## 4. 마무리

설계를 마친 경우, 다음과 같은 추가 질문을 제시할 수 있다.

- 시계 동기화 : 여러 나라에 걸쳐 데이터센터가 분산되어 있는 경우, 시간에 대해 고민해볼 수 있다.
  
- 각 절의 길이 최적화 : 환경에 따라 각 섹션의 길이를 유동적으로 변경할 수 있다.(작동 중 변경은 절대 금지)
- 가용성 문제 : ID 생성기는 필수 불가결 컴포넌트이므로 높은 가용성을 제공해야 한다.
