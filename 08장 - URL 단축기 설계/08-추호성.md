# 8. URL 단축기 설계

URL 단축기 설계 문제를 해결해보자

## 1. 문제 이해 및 설계 범위 확정

면접관과 이야기하며 문제의 모호성을 줄이고 설계 범위를 확정하자. 다음과 같은 추정이 나왔다.

- 쓰기 연산 : 매일 1억개의 단축 URL 생성
- 초당 쓰기 연산 : 1억/24시간/3600초 = 1160
- 읽기 연산 : 쓰기 연산의 10배라고 하자. 따라서, 초당 11600회 발생
- URL 서비스를 10년 운영한다면 1억 * 365 * 10 = 3650억개의 URL 보관 필요
- 축약 전 URL의 평균 길이는 100이라고 가정하며, 10년 동안 3650억 * 100바이트 = 36.5TB

## 2. 개략적 설계안 제시 및 동의 구하기

API 엔드포인트, URL 리디렉션, URL 단축 흐름에 대해 살펴보자.

### API 엔드포인트

클라이언트는 서버가 제공하는 API 엔드포인트를 통해 서버와 통신하며, 이 때, REST 스타일로 설계할 예정이다. 다음은 클라이언트와 통신하는 2개의 API다.

- POST `/api/v1/data/shorten` : longURLString을 body에 담아 전송하면 이를 저장한 뒤, 단축 URL을 반환한다.
- GET `/api/v1/shortUrl` : 원래 URL을 반환한다.

### URL 리디렉션

GET 메서드를 이용하여 단축 URL을 전송하면 원본 URL을 반환받을 수 있다. 이 때, http status 코드로 301 혹은 302 코드를 받을 수 있는데, 이 둘은 차이점을 가지고 있다.

- 301 코드는 주어진 URL에 대한 HTTP 요청의 처리 책임이 원본 URL로 영구히 이전되었음을 나타낸다. 따라서, 추후 같은 단축 URL에 요청을 보낼 경우, 브라우저는 이 응답을 캐시하여 원래 URL로 요청을 보내게 된다.(URL 단축 서버를 거치지 않음)
- 302 코드는 주어진 URL에 대한 HTTP 요청의 처리 책임이 일시적으로 본인에 의해 처리됨을 나타낸다. 즉, URL 단축 서버를 거친 후, 리디랙션된다. 이는 URL 단축 서버에서 로그를 기록하는 등 추가 조치를 취할 수 있음을 나타낸다.

URL 리디렉션을 구현하는 가장 직관적인 방법은 해시 테이블을 사용하는 것이다. 

### URL 단축 흐름

URL 단축을 위해 해시 함수를 사용해야 하는데, 이는 다음 요구사항을 만족해야 한다.

- 다른 키에 의해 해시 함수가 적용된 값은 중복되면 안된다.
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 한다.

## 3. 상세 설계

설계해보자.

### 데이터 모델

먼저 DB 모델을 설계해보자. 단축 URL과 원본 URL을 매핑할 수 있어야 하므로 ID, short URL, long URL 컬럼을 가질 수 있다.

### 해시 함수

원본 URL을 단축 URL과 매핑할 수 있도록 효율적인 해시 함수를 설계해야 한다. 먼저 데이터의 크기를 고민해보자. 해시 값은 숫자, 소문자, 대문자로 구성될 수 있다. 즉 해시 값은 62의 n 제곱의 크기를 가진다. 여기서 n은 해시값의 길이다. 요구 사항에서 3650억개의 단축 url이 필요하다고 했으니 n은 7로 지정하자. (62^7=3.5조)

해시 함수 구현 기술은 ‘해시 후 충돌 해소’와 ‘base-62 변환’으로 나뉘어진다.

### 해시 후 충돌 해소

해시 후 충돌 해소는 CRC32, MD5, SHA-1와 같은 잘 알려진 해시 함수를 이용하며, 정의한 해시 값의 길이만큼 잘라서 사용하는 방식이다.

값을 잘라서 사용하기 때문에 충돌이 발생할 수 있는데, 이럴 경우 원본 URL에 사전에 정의된 문자열을 추가하여 다시 해시 함수를 적용한다. 이를 충돌이 발생하지 않을 때 까지 반복한다.

충돌이 일어날 때 마다 DB에 해시 값의 존재 여부를 질의해야 하기 때문에 오버헤드가 발생한다. 이를 블룸 필터를 이용해서 해결할 수 있다.

다음과 같은 특징을 가진다.

- 단축 URL의 길이가 고정적
- 유일성이 보장되는 ID가 필요하지 않음
- 충돌 해소 전략 필요
- 보안상 안전함

..

### BASE-62 변환

BASE-62 변환 기법은 원본 URL을 62진수(숫자+소문자+대문자)로 변환하여 저장하는 방식이다. 다음과 같은 특징을 가지고 있다.

- 단축 URL의 길이가 가변적
- 유일한 ID가 필요 → 충돌 가능성 없음
- 단축 URL을 쉽게 유추할 수 있어서 보안상 문제가 발생할 수 있음

### URL 단축기 상세 설계

1. 입력으로 긴 URL 받기
2. DB에서 해당 URL이 있는지 검사
3. 존재한다면 값을 반환
4. 없는 경우 기본 키 생성
5. BASE-62를 이용해서 기본 키를 단축 URL로 변경
6. 기본 키, 원본 URL, 단축 URL 쌍의 새로운 레코드를 만든 후 단축 URL을 클라이언트에 전달

### URL 리다이렉션 상세 설계

다음과 같이 설계할 수 있다.

..

## 4. 마무리

개인적인 설계는 다음과 같다.
..

추가적으로 다음을 이야기할 수 있다.

- 처리율 제한 장치
- 웹 서버의 규모 확장
- DB의 규모 확장
- 데이터 분석 솔루션
- 가용성, 데이터 일관성, 안정성 등 다중화 시스템에서 중요한 요소