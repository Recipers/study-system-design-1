# 14. 유튜브 설계

유튜브 업로드, 재생 기능을 만들어보자

<br>

## 1. 문제 이해 및 설계 범위 확정

- 비디오 업로드 및 시청 기능

- 모바일 앱, 웹, 스마트 TV 지원
- DAU 500만, 하루 30분 소비
- 다국어 지원
- 현존하는 비디오 종류와 해상도를 대부분 지원
- 비디오 파일 크기는 1GB로 제한
- 클라우드 서비스 활용 가능

즉 다음 기능을 갖는 비디오 스트리밍 서비스 설계에 초점을 맞출 것이다.

- 빠른 비디오 업로드

- 원활한 비디오 재생
- 재생 품질 선택
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 그리고 안정성
- 다양한 지원 클라이언트

<br>

## 2. 개략적 설계안 제시 및 동의 구하기

개략적으로 다음의 아키텍쳐를 가진다.

- 사용자 단말 : 단말을 통해 유튜브를 시청할 수 있다.

- CDN : 비디오는 CDN에 저장한다. 재생을 누르면 CDN으로부터 스트리밍이 이루어진다.
- API 서버 : 비디오 스트리밍을 제외한 모든 요청을 처리한다. 피드 추천, 비디오 업로드 URL 생성, 메타데이터 DB와 캐시 갱신, 사용자 가입 등등
  
![image (14)](https://github.com/user-attachments/assets/33d95a6f-bad2-4f02-b37d-a6e7f204c0cd)

### 비디오 업로드 절차

비디오 업로드 절차의 개략적 설계안은 다음과 같다.

- 사용자 : 단말을 통해 유튜브를 시청

- 로드밸런서 : API 서버 각각으로 고르게 요청을 분산하는 역할
- API 서버 : 스트리밍을 제외한 모든 요청을 처리
- 메타데이터 DB : 비디오의 메타데이터를 보관. 샤딩과 다중화를 적용하여 성능 및 가용성 요구사항을 충족아이콘 추가
- 메타데이터 캐시 : 성능을 높이기 위해 비디오 메타데이터와 사용자 객체는 캐시
- 원본 저장소 : 원본 비디오를 보관할 대형 이진 파일 저장소 시스템
- 트랜스코딩 서버 : 비디오 트랜스코딩은 비디오 인코딩이라 부르기로 하는 절차로, 비디오의 포맷을 변환하는 절차. 단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림을 제공하기 위해 필요(형식과 화질을 나누기 위한 작업)
- 트랜스코딩 비디오 저장소 : 트랜스코딩이 완료된 비디오를 저장하는 저장소
- CDN : 비디오를 캐시하는 역할. 사용자가 재생을 누르면 비디오 스트리밍은 CDN을 통해 이루어짐
- 트랜스코딩 완료 큐 : 비디오 트랜스코딩 완료 이벤트르 보관할 메세지 큐
- 트랜스코딩 완료 핸들러 : 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타 데이터 캐시와 데이터베이스를 갱신할 작업 서버

비디오 업로드 프로세스는 다음과 같다.

먼저, 비디오 업로드 절차다.

1. 비디오를 원본 저장소에 업로드한다.

2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩을 시작한다.
3. 트랜스코딩이 완료되면 두 절차가 병렬적으로 수행된다.
    - 트랜스코딩이 끝난 비디오를 CDN에 올린다

    - 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다
    - 완료 핸들러가 메타데이터 DB와 캐시를 갱신한다
4. API 서버가 단말에게 비디오 업로드가 끝나서 스트리밍 준비가 되었음을 알린다.

![image (15)](https://github.com/user-attachments/assets/1d621f8c-776b-485e-93f4-288fc0b2133e)

다음으로 메타데이터 갱신이다.

원본 저장소에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다. 이 요청에 포함된 메타데이터에는 이름, 크기, 포맷 등의 정보가 들어간다. API 서버는 이 정보로 메타데이터 캐시와 DB를 업데이트한다.

결국 메타데이터는 비디오 업로드 중, 두 번 갱신된다.

- 원본 저장소 파일이 업로드되는 시점에 메타데이터를 캐시와 DB에 입력

- 트랜스코딩이 완료되는 시점에 완료 핸들러가 메타데이터 캐시와 DB를 갱신

![image (16)](https://github.com/user-attachments/assets/19150eae-c63e-4493-895e-d716e5fe04ce)

### 비디오 스트리밍 절차

유튜브 재생을 다운로드 없이 재생되는 스트리밍 형식으로 이루어진다. 

이를 구현하기 위해 스트리밍 프로토콜을 이용하게 되는데, 이는 비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신방법이다. 중요한 점은, 프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다는 점이다. 이에 따라, 서비스를 설계할 때, 용례에 맞는 프로토콜을 잘 골라야 한다. MPEG-DASH, 애플 HLS, MS 스무드 스트리밍 등이 존재한다.

비디오는 사용자의 단말에 가장 가까운 CDN 서버에서 전송된다. 

![image (17)](https://github.com/user-attachments/assets/9d8799fa-1999-4818-a28b-b2f48aa14585)

<br>

## 3. 상세 설계

비디오 업로드와 재생 흐름을 자세히 확인하고 최적화해보자.

### 비디오 트랜스코딩

업로드한 비디오가 다른 단말에서 호환되려면 비트레이트와 포맷으로 저장되어야 한다. 여기서 비트레이트는 비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지를 나타내는 단위다.

비디오 트랜스코딩은 다음과 같은 이유로 중요하다.

- 가공되지 않은 원본 비디오는 많은 저장공간을 차지한다. → 이는 사용자 입장에서 스트리밍할 때 부담스로울 수 있다.

- 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원한다. 따라서, 하나의 비디오를 여러 포맷으로 인코딩해야 한다.
- 사용자의 네트워크 환경에 따라, 적절한 그리고 유동적인 화질의 비디오를 전송하는 것이 바람직하다.

인코딩 포맷은 다양하지만 대부분 컨테이너와 코덱으로 구성되어 있다. 컨테이너는 메타데이터를 담는 바구니 역할이며, 코덱은 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 해제 알고리즘이다.

### 유향 비순환 그래프 모델(DAG)

유향 비순환 그래프 모델(DAG)은 비디오 트랜스코딩 작업을 맡으며, 다음과 같은 효과를 가진다. (트랜스코딩 서버에서 처리되는건가?)

- 각기 다른 유형의 비디오 프로세싱 파이프라인을 지원

- 처리 과정의 다양성과 작업의 병렬성을 높이기 위해 적절히 추상화

DAG는 다음과 같이 구성된다. 비디오, 오디오, 메타데이터를 각각 처리하며, 비디오 부분에 적용되는 작업은 다음과 같다. 

- 검사 : 좋은 품질의 비디오인지, 손상은 없는지 확인하는 작업

- 비디오 인코딩 : 비디오를 다양한 해상도(360p, 480p .. ), 코덱, 비트레이트 조합으로 인코딩하는 작업
- 섬네일 : 사용자가 업로드한 이미지나 비디오에서 자동 추출된 이미지로 섬네일을 만드는 작업
- 워터마크 : 비디오 식별 정보를 이미지 위에 오버레이 형태로 띄우는 작업

![image (18)](https://github.com/user-attachments/assets/977786ee-2155-4abe-9ac7-9a54f2e545a8)

### 비디오 트랜스코딩 아키텍쳐

비디오 트랜스코딩 아키텍쳐는 다음과 같이 정의된다. 즉, 트랜스코딩 작업이 다음 과정을 따른다는 것이다.

![image (19)](https://github.com/user-attachments/assets/ea361d6d-c9ec-45b3-a006-557d999a375f)

전처리기는 다음과 같은 역할을 한다.

- 비디오 분할 : 비디오 스트림을 몇 초 단위의 비디오 스트림(GOP)으로 쪼갠다. GOP는 특정 순서로 배열된 프레임 그룹이다. 비디오 분할을 지원하지 않는 오래된 단말에서 전처리기가 이를 대신한다.

- DAG 생성 : 클라이언트가 작성한 설정에 따라 DAG를 만들어낸다. 작업과 순서를 노드와 엣지로 표현할 수 있다.
- 데이터 캐시 : 전처리기는 분할된 비디오의 캐시 역할을 한다. 안정성을 높이기 위해 GOP와 메타데이터를 임시저장소에 보관한다. 인코딩이 실패할 경우, 임시 저장소에서 다시 가져와 인코딩을 재개한다.

원본 저장소에서 데이터가 쪼개져서 임시 저장소를 거친 뒤, 트랜스코딩 서버로 이동하는건가? 아니다. 사용자 단말에서 GOP로 쪼개진 데이터를 원본 저장소에 저장한다.

DAG 스케줄러는 다음과 같은 역할을 한다.

DAG 스케줄러는 DAG 그래프를 몇 개 단계로 분할한 다음에 그 각각을 자원 관리자의 작업 큐에 넣는다. 다음은 2단계로 구분한 사례다. 1단계 작업 전부 → 2단계 작업 전부를 자원 관리자의 작업 큐에 넣는다.

이렇게 작동하면 어떤 장점이 있지 ?

![image (20)](https://github.com/user-attachments/assets/ab3ad561-0aa8-4f57-8348-23a8b5c00a8e)

지원 관리자는 다음과 같은 역할을 한다.

지원 관리자는 자원 배분을 효과적으로 수행하는 역할을 한다.

- 작업 큐 : 실행할 작업이 보관되어 있는 우선순위 큐

- 작업 서버 큐 : 작업 서버의 가용 상태 정보가 보관되어 있는 우선순위 큐
- 실행 큐 : 현재 실행 중인 작업 및 작업 서버 정보가 보관되어 있는 큐
- 작업 스케줄러 : 최적의 작업/서버 조합을 골라, 해당 작업 서버가 작업을 수행하도록 지시하는 역할

![image (21)](https://github.com/user-attachments/assets/87df56a2-bed3-4147-ba8b-549b4d473229)

이런식으로 작동하는건가? : 비디오 인코딩을 작업한다면, 비디오 인코딩 작업을 작업 큐에서 추출 → 이에 맞는 작업 서버를 작업 서버 큐에서 추출 → 실행 → 실행 큐에 작업 및 서버 입력 → 실행 마칠 경우, 실행 큐에서 추출 및, 해당 작업 서버를 작업 서버 큐에 적재

작업 서버는 다음과 같은 역할을 한다.

작업 서버는 DAG에 정의된 작업을 수행한다. 작업의 종류에 따라 작업 서버도 구분하여 관리한다.

![image (22)](https://github.com/user-attachments/assets/91edcf6d-81ac-47c8-99ce-4ef7ad1d0cff)

임시 저장소는 다음과 같은 역할을 한다.

임시 저장소는 용도에 맞는 다양한 계층을 가질 수 있으며, 비디오 프로세싱이 완료되면 삭제된다는 특징을 가진다. 예를 들어, 메타데이터의 경우 크기가 작고 빈번히 참조되기 때문에 임시 저장소의 캐시에 저장하며, GOP의 경우 BLOB 저장소에 두는 것이 바람직하다.

인코딩된 비디오는 인코딩 파이프라인의 최종 결과물이다. funny_720p.mp4 같은 이름을 가지낟.

### 시스템 최적화

속도, 안정성, 비용을 최적화해보자.

비디오 병렬 업로드를 통해 속도를 최적화할 수 있다. 사용자 단말에서 GOP 형태로 원본 저장소에 저장되는데, 이는 병렬성을 높여 업로드 속도를 높여주며, 일부가 업로드 실패해도 빠르게 복구할 수 있다는 장점을 가진다.

업로드 센터를 사용자 근거리에 지정하는 방식으로 속도를 최적화할 수 있다. 여러 지역에 업로드 센터를 두어 속도를 개선한다. 본 설계안에서는 CDN을 업로드 센터로 이용한다.(즉 스트리밍과 업로드를 같은 서버에서 한다)

모든 절차를 병렬화하는 방식으로 속도를 최적화할 수 있다. 느슨하게 결합된 시스템을 만들어 병렬성을 높이는 방법이 있다. 기존 방법의 경우, 특정 단계의 결과물은 이전 단계의 결과물을 입력으로 사용하여 만들어지는 의존성이 있기 때문에 병렬성을 높이기 어렵다.(가장 속도가 느린 단계에 맞출 수 밖에 없다)

![image (23)](https://github.com/user-attachments/assets/43f5f499-0215-4f28-9c9a-ac4f6091ca2f)

이 시스템의 결합도를 낮추기 위해, 메세지 큐를 도입한다. 단계 사이에 메세지 큐를 넣어, 완료된 이벤트를 저장한다. 이 덕분에 각 절차를 병렬적으로 처리할 수 있게 된다.

![image (24)](https://github.com/user-attachments/assets/8079021e-092d-44de-ab28-b4085e4ffefe)

미리 사인된 업로드 URL을 이용하여 안정성을 높일 수 있다. 업로드를 요청할 때, 비디오를 바로 저장하지 않고, 미리 준비된 URL을 받은 뒤, 그 위치에 저장한다고 생각하자. 절차는 다음과 같다.

1. 클라이언트는 POST 요층을 하여 미리 사인된 URL을 받는다. 이 때, 해당 URL이 가리키는 객체에 대한 접근 권한이 이미 주어져 있는 상태다.(여기서 URL은 객체를 저장할 스토리지 주소를 의미한다)

2. API 서버는 미리 사인된 URL을 돌려준다.
3. 클라이언트는 해당 URL이 가리키는 위치에 비디오를 업로드한다.

비디오 저작권 보호를 위한 다양한 선택지가 있다.

- 디지털 저작권 관리 시스템 : 컨텐츠 암호화, 사용자 인증 및 관리 등 보안 시스템을 의미한다. DRM은 단점도 존재하는데, 사용자는 기기 별 재생 제한, 오프라인 사용 불가 등 불편을 겪을 수 있다. 애플의 페어플레이, 구글의 와이드바인 등이 있다.

- AES 암호화 : 비디오를 암호화하고 접근 권한을 설정하는 방식이다.
- 워터마크 : 비디오 위에 소유자 정보를 포함하는 이미지 오버레이를 올리는 것이다.

CDN 비용을 최적화할 수 있다. 유튜브의 비디오 스트리밍은 롱테일 분포를 따른다. 인기 있는 비디오와 나머지 비디오는 재생 횟수에서 큰 격차를 보인다. 이에 맞춰 몇 가지 최적화를 시도할 수 있다.

1. 인기 비디오는 CDN을 통해 재생하되, 다른 비디오는 비디오 서버를 통해 재생한다.

2. 인기가 별로 없는 비디오는 인코딩 할 필요가 없을 수 있다. 짧은 비디오라면 필요할 때 인코딩하여 재생할 수 있다.(조회 시점에 작동)
3. 어떤 비디오는 특정 지역에서만 인기가 높다.
4. ISP와 제휴하여 사용자 경험을 향상시키고 인터넷 사용 비용을 낮출 수 있다.

모든 최적화는 컨텐츠 인기도, 이용 패턴, 비디오 크기 등의 데이터에 근거한 것이다. 따라서, 시청 패턴을 분석하는 것은 중요하다.

시스템 오류는 대형 시스템에서는 불가피하다. 장애 감내 시스템을 만드려면, 오류를 우아하게 처리하고 빠르게 회복해야 한다. 시스템 오류는 두 가지가 있다.

- 회복 가능 오류 : 특정 비디오 세그먼트(GOP?)를 트랜스코딩하다 실패한 경우가 해당 오류에 속한다. 일반적으로 이는 재시도로 해결된다. 그래도 실패할 경우, 사용자에게 오류 코드를 반환해야 한다.

- 회복 불가능 오류 : 비디오 포멧이 잘못되었거나하는 오류가 회복 불가능 오류이며, 시스템은 해당 작업을 중단하고 클라이언트에게 적절한 오류 코드를 반환해야 한다.

각 컴포넌트에서 발생할 수 있는 오류는 대부분 재시도로 해결된다.

<br>

## 4. 마무리

다음과 같은 내용을 논의해도 좋을 것이다.

- API 계층의 규모 확장성 확보 방안 : 무상태성을 기반한다면 수평적 확장을 의논하자

- DB 계층의 규모 확장성 확보 방안 : DB의 다중화와 샤딩 방법에 대해 이야기하자
- 라이브 스트리밍 : 비-라이브 스트리밍과 시스템이 유사하지만, 실시간성이 더욱 강조된다.
- 비디오 삭제 : 저작권 위반 비디오, 불건전한 비디오는 내려야 한다. 업로드 과정에서 식별할 수 있지만, 사용자의 신고 절차를 통해 판별할 수 있다.

<br>

## 5. 질문

- 샤딩과 다중화란
